---
# Report-only per-user-per-IP concurrency using active sockets + last /live request

# You can set these in role defaults/vars; these are safe fallbacks
- name: "Report Concurrency | Defaults"
  ansible.builtin.set_fact:
    __nginx_access_log: "{{ role_iptvservice__nginx_access_log | default('/var/log/nginx/yiafe_access.log') }}"
    __default_user_cap: "{{ role_iptvservice__default_max_connections | default(2) }}"

# 1) Get current established client connections to Nginx :80
- name: "Report Concurrency | ss :80 established"
  ansible.builtin.command:
    cmd: ss -Htn sport = :80 state established
  register: __ss80
  changed_when: false
  failed_when: false

# 2) Extract client IPv4s from ss output
- name: "Report Concurrency | Extract client IPv4s"
  ansible.builtin.set_fact:
    __client_ips: >-
      {{
        (__ss80.stdout | default(''))
        | regex_findall('(?:\\S+):80\\s+(\\d+\\.\\d+\\.\\d+\\.\\d+):\\d+', multiline=True)
        | unique
      }}

# Short-circuit if nothing connected
- name: "Report Concurrency | No active client sockets"
  ansible.builtin.debug:
    msg: "No ESTABLISHED client sockets to :80; nothing to report."
  when: (__client_ips | length) == 0

- name: "Report Concurrency | Continue only if we have client IPs"
  ansible.builtin.meta: noop
  when: (__client_ips | length) > 0

# 3) Tail recent access log for quick lookup
- name: "Report Concurrency | Tail nginx access log"
  ansible.builtin.command:
    cmd: tail -n 100000 "{{ __nginx_access_log }}"
  register: __log_tail
  changed_when: false
  failed_when: false
  when: (__client_ips | length) > 0

# 4) Build (user, ip) pairs by finding each IP's most recent /live/ line
#    Extract username from either:
#     - /live/<user>/<pass>/<id>...
#     - /<USERNAME>/live/<user>/<pass>/<id>...
- name: "Report Concurrency | Build (user,ip) pairs from log"
  ansible.builtin.set_fact:
    __user_ip_pairs: >-
      {%- set out = [] -%}
      {%- for ip in __client_ips -%}
        {%- set lines = (__log_tail.stdout_lines | default([])) | select('match', '^' ~ ip ~ ' ') | select('search', '/live/') | list -%}
        {%- set last = (lines | last | default('')) -%}
        {%- set u = (last | regex_findall('/(?:[^/]+/)?live/([^/]+)/') | last | default('')) -%}
        {%- if u | length > 0 -%}
          {%- set _ = out.append({'user': u, 'ip': ip}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}
  when: (__client_ips | length) > 0

# 5) Create a "user|ip" key list and count occurrences
- name: "Report Concurrency | Compose keys list"
  ansible.builtin.set_fact:
    __keys: >-
      {%- set out = [] -%}
      {%- for p in (__user_ip_pairs | default([])) -%}
        {%- set _ = out.append(p.user ~ '|' ~ p.ip) -%}
      {%- endfor -%}
      {{ out }}
  when: (__client_ips | length) > 0

- name: "Report Concurrency | Counter by (user|ip)"
  ansible.builtin.set_fact:
    __key_counts: "{{ (__keys | default([])) | community.general.counter }}"
  when: (__client_ips | length) > 0

# 6) Build overages list comparing against per-user caps (__users or default)
- name: "Report Concurrency | Detect overages"
  ansible.builtin.set_fact:
    __overages: >-
      {%- set out = [] -%}
      {%- for k, v in (__key_counts | default({})).items() -%}
        {%- set parts = k.split('|') -%}
        {%- set u = parts[0] -%}
        {%- set ip = parts[1] if parts|length > 1 else 'unknown' -%}
        {%- set cap = (__users.get(u, {}).get('max_connections', __default_user_cap)) | int -%}
        {%- if (v | int) > cap -%}
          {%- set _ = out.append({'user': u, 'ip': ip, 'count': v | int, 'cap': cap}) -%}
        {%- endif -%}
      {%- endfor -%}
      {{ out }}
  when: (__client_ips | length) > 0

# 7) Email only if something exceeded
- name: "Report Concurrency | Compose mail body"
  ansible.builtin.set_fact:
    __mail_body: |
      Per-user concurrency over cap (observed via active sockets to :80 and latest /live/ request):

      {% for o in __overages %}
      - user: {{ o.user }}   ip: {{ o.ip }}   connections: {{ o.count }}   cap: {{ o.cap }}
      {% endfor %}
  when: (__overages | length) > 0

- name: "Report Concurrency | Email overages"
  community.general.mail:
    from: "{{ role_iptvservice__email_sender }}"
    to: "{{ role_iptvservice__email_recipients }}"
    subject: "IPTV concurrency over cap (per-user per-IP)"
    host: "{{ role_iptvservice__email_server }}"
    port: 25
    secure: never
    body: "{{ __mail_body }}"
  when: (__overages | length) > 0

# Optional debug when nothing exceeded
- name: "Report Concurrency | No overages"
  ansible.builtin.debug:
    msg: "No user+IP exceeded caps (active sockets checked: {{ __client_ips | length }})"
  when: (__overages | default([]) | length) == 0
